version: 2.1

orbs:
  semantic-release: trustedshops-public/semantic-release@5.0.0
  go: circleci/go@1.7.3

executors:
  go:
    docker:
      - image: cimg/go:1.20

jobs:
  test:
    executor: go
    working_directory: ~/project/monitor
    steps:
      - checkout:
          path: ..
      - go/mod-download-cached
      - run:
          name: Run tests
          command: |
            gotestsum --junitfile unit-tests.xml
            make save-coverage-report
      - run:
          name: Get test coverage
          command: |
            go test -race -coverprofile=coverage.txt -covermode=atomic  -v ./...
            # TODO Enable codecov
            # bash <(curl -s https://codecov.io/bash)
      - store_test_results:
          path: unit-tests.xml
      - store_artifacts:
          path: unit-tests.xml
      - store_artifacts:
          path: coverage.html
  build-monitor:
    executor: go
    working_directory: ~/project/monitor
    steps:
      - checkout:
          path: ..
      - go/mod-download-cached
      - run:
          name: Build binary for module
          command: |
            make build-multiplatform
      - persist_to_workspace:
          root: ~/project/
          paths:
            - monitor/dist/

  semantic-release:
    executor: semantic-release/default
    steps:
      - checkout
      - attach_workspace:
          at: ~/project/
      - semantic-release/install:
          additional_packages: "@semantic-release/exec@6.0.3"
      - semantic-release/execute

workflows:
  version: 2
  continuous:
    jobs:
      - test
      - build-monitor:
          requires:
            - test
      - semantic-release:
          context:
            - semantic-release
          requires:
            - build-monitor
          filters:
            branches:
              only: [main]
